using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using SS;
using SpreadsheetUtilities;
using System.Collections.Generic;
using System.Linq;
using System.Text.RegularExpressions;

namespace SpreadsheetTests
{
    [TestClass]
    public class UnitTest1
    {
        /// <summary>
        /// Normalizes all the variables in the
        /// formula class
        /// </summary>
        /// <param name="st"></param>
        /// <returns></returns>
        public String normalizer(String st)
        {
            //String inputChanger;
            st = st.ToUpper();
            //inputChanger = "_" + st;

            return st;
        }

        /// <summary>
        /// Makes sure the variable follows the newly
        /// enforced rules on variables
        /// </summary>
        /// <param name="st"></param>
        /// <returns></returns>
        public bool isValid(String st)
        {
            //Regex check = new Regex(@"(^[A-Z]");
            Regex check = new Regex(@"(^[A-Z]+[0-9]+)");
            if (check.IsMatch(st))
                return true;
            else
                return false;
        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void Test1EvaluateCellWithMultipleFormulas()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "5");
            sheet.SetContentsOfCell("B1", "10");
            sheet.SetContentsOfCell("C1", "=A1 + B1");

            Assert.AreEqual(15.0, sheet.GetCellValue("C1"));
        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void Test2EvaluateCellWithMultipleFormulas()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "=B1 + C1");
            sheet.SetContentsOfCell("B1", "=D1 + C1");
            sheet.SetContentsOfCell("C1", "5");
            sheet.SetContentsOfCell("D1", "10");

            Assert.AreEqual(20.0, sheet.GetCellValue("A1"));
        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void Test3EvaluateCellWithMultipleFormulas()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "=(B1 + C1) * 10");
            sheet.SetContentsOfCell("B1", "=C1 + D1 + 5");
            sheet.SetContentsOfCell("C1", "=D1 + 10");
            sheet.SetContentsOfCell("D1", "25");

            Assert.AreEqual(1000.0, sheet.GetCellValue("A1"));
        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void Test4EvaluateCellWithMultipleFormulas()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "=B1 + C1 + 10");
            sheet.SetContentsOfCell("B1", "=C1 + D1 + 5");
            sheet.SetContentsOfCell("C1", "=D1 + 10");
            sheet.SetContentsOfCell("D1", "25");

            Assert.AreEqual(110.0, sheet.GetCellValue("A1"));

            sheet.SetContentsOfCell("D1", "20");

            Assert.AreEqual(95.0, sheet.GetCellValue("A1"));
            sheet.SetContentsOfCell("D1", "String");
            Assert.AreEqual(new FormulaError("Error: cell value not valid or empty"), sheet.GetCellValue("A1"));
            Assert.AreEqual(new FormulaError("Error: cell value not valid or empty"), sheet.GetCellValue("B1"));
            Assert.AreEqual(new FormulaError("Error: cell value not valid or empty"), sheet.GetCellValue("C1"));

        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void Test5EvaluateCellWithString()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "String");

            Assert.AreEqual("String", sheet.GetCellValue("A1"));
        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test5GetInvalidName()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "String");

            sheet.GetCellValue("1B");
        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(ArgumentNullException))]
        public void Test5GetInvalidContent()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", null);


        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]

        public void Test5GetValidNameEmptyValue()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "String");

            Assert.AreEqual("", sheet.GetCellValue("B1"));
        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test5GetNullName()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "String");

            sheet.GetCellValue(null);
        }
        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void Test6EvaluateCellWithDoubleThenString()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "15");
            sheet.SetContentsOfCell("A1", "String");

            Assert.AreEqual("String", sheet.GetCellValue("A1"));
        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void TestFormulaEqualString()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "=B1");
            sheet.SetContentsOfCell("B1", "String");

            Assert.AreEqual(new FormulaError("Error: cell value not valid or empty"), sheet.GetCellValue("A1"));
            Assert.AreEqual("String", sheet.GetCellValue("B1"));

        }
        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void Test7EvaluateCellWithDelegateConst()
        {
            AbstractSpreadsheet sheet = new Spreadsheet(isValid, normalizer, "V2.1");

            sheet.SetContentsOfCell("a1", "String");

            Assert.AreEqual("A1", sheet.GetNamesOfAllNonemptyCells().ElementAt(0));
            Assert.AreEqual("String", sheet.GetCellValue("A1"));
        }

        /// <summary>
        /// Tests to see if name is null fails, should
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void TestGetCellContentsNullName()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            Assert.IsTrue(sheet.GetCellContents(null).GetType().Equals((typeof(Formula))));
        }


        /// <summary>
        /// Tests to see if name is null fails, should
        /// </summary>
        [TestMethod]

        public void TestGetCellContents()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "string");
            sheet.SetContentsOfCell("B1", "=C1");
            sheet.SetContentsOfCell("C1", "5.5");
            Assert.AreEqual("string", sheet.GetCellContents("A1"));
            Assert.AreEqual("=C1", sheet.GetCellContents("B1"));
            Assert.AreEqual(5.5, sheet.GetCellContents("C1"));
            Assert.AreEqual("", sheet.GetCellContents("D1"));
        }

        /// <summary>
        /// Tests to see if formula tests for circular dep, should fail
        /// creates the cell first as a double then trys to change it to
        /// a formula that should throw a circular exception
        /// 
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(CircularException))]
        public void TestForCircularDepCreatFormulaThenConvertToNewFormulaCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", ("=Z1 + X1"));

            sheet.SetContentsOfCell("B1", ("=A1 + C1"));
            sheet.SetContentsOfCell("C1", ("=A1"));
            sheet.SetContentsOfCell("A1", ("=B1"));

        }

        /// <summary>
        /// Tests to see if name is invalid fails, should
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void TestGetCellInvalidCellName()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            Assert.IsTrue(sheet.GetCellContents("1B").GetType().Equals((typeof(Formula))));
        }

        /// <summary>
        /// Tests to see if formula tests for circular dep, should fail
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(CircularException))]
        public void TestForCircularDepFormulaCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("B1", "=A1 + C1");
            sheet.SetContentsOfCell("C1", "=A1");
            sheet.SetContentsOfCell("A1", "=B1");
        }

        /// <summary>
        /// Tests to see if formula tests for circular dep, should fail
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(CircularException))]
        public void TestForCircularDepFormulaCell2()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("B1", "=A1 + C1");
            sheet.SetContentsOfCell("C1", "=A1");
            sheet.SetContentsOfCell("A1", "=D1");
            sheet.SetContentsOfCell("A1", "=B1");
        }

        /// <summary>
        /// Tests to see if formula tests for circular dep, should fail
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(CircularException))]
        public void TestForCircularDepFormulaCell3()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("B1", "=A1 + C1");
            sheet.SetContentsOfCell("C1", "=A1");
            sheet.SetContentsOfCell("A1", "random text");
            sheet.SetContentsOfCell("A1", "=B1");

        }

        /// <summary>
        /// Tests to see if formula tests for circular dep, should fail
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(CircularException))]
        public void TestForCircularDepFormulaCell4()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("B1", "=A1 + C1");
            sheet.SetContentsOfCell("C1", "=A1");
            sheet.SetContentsOfCell("A1", "5.0");
            sheet.SetContentsOfCell("A1", "=B1");

        }

        /// <summary>
        /// Tests to see if invalid name is caught in text cell
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void TestForInvalidNameForTextCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("1B", "Invalid name?");
        }


        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void Test8TestSaveMethod()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            sheet.SetContentsOfCell("A1", ("=B1 + C1"));
            sheet.SetContentsOfCell("B1", "10");
            sheet.SetContentsOfCell("C1", "15");

            sheet.Save("firstSave");

            sheet.SetContentsOfCell("D1", "52");

            sheet.Save("firstSave");
        }

        /// <summary>
        /// Tests create spreedsheat 1 add data, save data. Creat spreadsheet 2, load
        /// data from saved file and compare that it was done
        /// </summary>
        [TestMethod]
        public void Test9TestSaveThenLoadWithPathToFileConst()
        {
            String fileName = "firstSave";

            AbstractSpreadsheet sheet1 = new Spreadsheet();

            sheet1.SetContentsOfCell("A1", ("=B1 + C1"));
            sheet1.SetContentsOfCell("B1", "50");
            sheet1.SetContentsOfCell("C1", "15");

            List<String> cellsOfSheet1 = sheet1.GetNamesOfAllNonemptyCells().ToList();

            sheet1.Save(fileName);

            AbstractSpreadsheet sheet2 = new Spreadsheet(fileName, s => true, s => s, "default");

            List<String> cellsOfSheet2 = sheet2.GetNamesOfAllNonemptyCells().ToList();

            for (int i = 0; i < cellsOfSheet1.Count; i++)
                Assert.AreEqual(cellsOfSheet1.ElementAt(i), cellsOfSheet2.ElementAt(i));
        }

        /// <summary>
        /// Tests to see if saved version is same as version passed in const, should fail
        /// </summary>
        [TestMethod]
        public void TestTestValidVersionFromSavedVersionToVersonPassedIn()
        {
            String fileName = "firstSave";

            AbstractSpreadsheet sheet1 = new Spreadsheet(s => true, s => s, "Version 1.0");

            sheet1.SetContentsOfCell("A1", ("=B1 + C1"));
            sheet1.SetContentsOfCell("B1", "20");
            sheet1.SetContentsOfCell("C1", "15");

            List<String> cellsOfSheet1 = sheet1.GetNamesOfAllNonemptyCells().ToList();

            sheet1.Save(fileName);

            AbstractSpreadsheet sheet2 = new Spreadsheet(fileName, s => true, s => s, "Version 1.0");
            Assert.AreEqual("Version 1.0", sheet2.GetSavedVersion(fileName));
            List<String> cellsOfSheet2 = sheet2.GetNamesOfAllNonemptyCells().ToList();
        }

        /// <summary>
        /// Tests to see if saved version is same as version passed in const, should fail
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(SpreadsheetReadWriteException))]
        public void Test10TestInvalidVersionFromSavedVersionToVersonPassedIn()
        {
            String fileName = "firstSave";

            AbstractSpreadsheet sheet1 = new Spreadsheet(s => true, s => s, "Version 1.0");

            sheet1.SetContentsOfCell("A1", ("=B1 + C1"));
            sheet1.SetContentsOfCell("B1", "20");
            sheet1.SetContentsOfCell("C1", "15");

            List<String> cellsOfSheet1 = sheet1.GetNamesOfAllNonemptyCells().ToList();

            sheet1.Save(fileName);

            AbstractSpreadsheet sheet2 = new Spreadsheet(fileName, s => true, s => s, "Version 1.1");

            List<String> cellsOfSheet2 = sheet2.GetNamesOfAllNonemptyCells().ToList();
        }

        /// <summary>
        /// Tests to see if saved version is same as version passed in const, should fail
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(SpreadsheetReadWriteException))]
        public void Test13TestInvalidVersionFromSavedVersionToVersonPassedIn()
        {
            String fileName = "firstSave";

            AbstractSpreadsheet sheet1 = new Spreadsheet(s => true, s => s, "Version 1.0");

            sheet1.SetContentsOfCell("A1", ("=B1 + C1"));
            sheet1.SetContentsOfCell("B1", "20");
            sheet1.SetContentsOfCell("C1", "15");
            Assert.IsTrue(sheet1.Changed);
            List<String> cellsOfSheet1 = sheet1.GetNamesOfAllNonemptyCells().ToList();

            sheet1.Save(fileName);

            AbstractSpreadsheet sheet2 = new Spreadsheet(fileName, s => true, s => s, "Version 1.0");
            sheet2.GetSavedVersion("invalid/Name");

        }

        /// <summary>
        /// Tests to see if saved version is same as version passed in const, should fail
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(SpreadsheetReadWriteException))]
        public void Test11TestInvalidVersionFromSavedVersionToVersonPassedIn()
        {
            String fileName = "first/Save";

            AbstractSpreadsheet sheet1 = new Spreadsheet(s => true, s => s, "Version 1.0");

            sheet1.SetContentsOfCell("A1", ("=B1 + C1"));
            sheet1.SetContentsOfCell("B1", "20");
            sheet1.SetContentsOfCell("C1", "15");

            List<String> cellsOfSheet1 = sheet1.GetNamesOfAllNonemptyCells().ToList();

            sheet1.Save(fileName);


        }

        /// <summary>
        /// Tests to see if file exists, DNE and should throw exception
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(SpreadsheetReadWriteException))]
        public void Test11TestFileDNE()
        {
            String fileName = "testFileName";

            AbstractSpreadsheet sheet2 = new Spreadsheet(fileName, s => true, s => s, "Version 1.1");
        }

        /// <summary>
        /// Tests value of cell
        /// </summary>
        [TestMethod]
        public void Test10EvaluateCellWithMultipleFormulas()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "=B1 + C1 + 10");
            sheet.SetContentsOfCell("B1", "=C1 + D1 + 5");
            sheet.SetContentsOfCell("C1", "=D1 + 10");
            sheet.SetContentsOfCell("D1", "25");

            Assert.AreEqual(110.0, sheet.GetCellValue("A1"));

            sheet.SetContentsOfCell("D1", "20");

            Assert.AreEqual(95.0, sheet.GetCellValue("A1"));
            sheet.SetContentsOfCell("D1", "String");
            Assert.AreEqual(new FormulaError("Error: cell value not valid or empty"), sheet.GetCellValue("A1"));
            Assert.AreEqual(new FormulaError("Error: cell value not valid or empty"), sheet.GetCellValue("B1"));
            Assert.AreEqual(new FormulaError("Error: cell value not valid or empty"), sheet.GetCellValue("C1"));
        }



        /// <summary>
        /// Tests Constructor, tests to make sure no cells exist, which shouldn't
        /// </summary>
        [TestMethod]
        public void TestConstructor()
        {
            IEnumerable<String> tempList = new List<String>();

            AbstractSpreadsheet sheet = new Spreadsheet();
            tempList = sheet.GetNamesOfAllNonemptyCells().ToList();

            Assert.AreEqual(0, tempList.Count());
        }

        /// <summary>
        /// Tests to the cell name to make sure is invalid name, should throw
        /// expception
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void TestValidName1()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("5", ("5 + 2"));
        }


        /// <summary>
        /// Tests adding a formula to the spreedsheet
        /// </summary>
        [TestMethod]
        public void TestAddFormulaToSpreedSheetWithMultipleCellsReferenced()
        {
            ISet<String> tempsVariablesReturned = new HashSet<String>();
            List<String> expectedVaribles = new List<string>
            {
                "A1",
                "C1",
                "B1"
            };

            AbstractSpreadsheet sheet = new Spreadsheet();
            tempsVariablesReturned = sheet.SetContentsOfCell("A1", ("B1 + C1"));

            for (int i = 0; i < tempsVariablesReturned.Count; i++)
                Assert.AreEqual(expectedVaribles.ElementAt(i), tempsVariablesReturned.ElementAt(i));
        }

        /// <summary>
        /// Tests adding text cell then formula cell, making sure has correct Dependents
        /// </summary>
        [TestMethod]
        public void TestAddFormulaToSpreedSheetWithMultipleCellsReferencedAddNewCellToExistingCell()
        {
            ISet<String> tempsVariablesReturned = new HashSet<String>();
            List<String> expectedVaribles = new List<string>
            {
                "B1",
                "A1"
            };

            AbstractSpreadsheet sheet = new Spreadsheet();
            tempsVariablesReturned = sheet.SetContentsOfCell("A1", "String");
            tempsVariablesReturned = sheet.SetContentsOfCell("B1", ("A1"));

            for (int i = 0; i < tempsVariablesReturned.Count; i++)
                Assert.AreEqual(expectedVaribles.ElementAt(i), tempsVariablesReturned.ElementAt(i));
        }

        /// <summary>
        /// Tests adding text cell then formula cell, making sure has correct Dependents
        /// </summary>
        [TestMethod]
        public void TestAddFormulaAndAddTwoOtherCellsTheDependOnFormulaCell()
        {
            ISet<String> tempsVariablesReturned = new HashSet<String>();
            List<String> expectedVaribles = new List<string>
            {
                "A1",
                "B1",
                "C1"
            };

            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("B1", ("A1*2"));
            sheet.SetContentsOfCell("C1", ("B1+A1"));
            tempsVariablesReturned = sheet.SetContentsOfCell("A1", ("2"));

            for (int i = 0; i < tempsVariablesReturned.Count; i++)
                Assert.AreEqual(expectedVaribles.ElementAt(i), tempsVariablesReturned.ElementAt(i));
        }


        /// <summary>
        /// Tests to see if name is invalid fails, should
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void TestGetCellContentsInvalidCellName()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            Assert.IsTrue(sheet.GetCellContents("1A").GetType().Equals((typeof(Formula))));
        }


        /// <summary>
        /// Tests to see if null name for text field fails
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void TestForNullNameForTextCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell(null, "String");
        }

        /// <summary>
        /// Tests to see if null text for text field fails
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(ArgumentNullException))]
        public void TestForNullTextForTextCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            String tempString = null;
            sheet.SetContentsOfCell("A1", tempString);
        }

        /// <summary>
        /// Tests add a cell with formula then replace that cell with text
        /// </summary>
        [TestMethod]
        public void TestAddFormulaCellThenReplaceWithTextCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            sheet.SetContentsOfCell("A1", ("=B1 + C1"));
            sheet.SetContentsOfCell("A1", "String");
            Assert.IsTrue(sheet.GetCellContents("A1").GetType().Equals((typeof(String))));
        }

        /// <summary>
        /// Tests add a cell with formula then replace that cell with text
        /// </summary>
        [TestMethod]
        public void TestAddFormulaCellThenReplaceWithTextCellTestReturnedSet()
        {
            HashSet<String> testReturnedSet;

            AbstractSpreadsheet sheet = new Spreadsheet();

            sheet.SetContentsOfCell("A1", ("=B1 + C1"));
            testReturnedSet = (HashSet<String>)(sheet.SetContentsOfCell("A1", "String"));

            foreach (String st in testReturnedSet)
                Assert.AreEqual("A1", st);
        }

        /// <summary>
        /// Tests add a cell with formul that depends on text of other cell
        /// </summary>
        [TestMethod]
        public void TestAddTextAndFormulaSet()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            sheet.SetContentsOfCell("A1", ("String"));
            sheet.SetContentsOfCell("B1", ("=A1"));
        }

        /// <summary>
        /// Tests add a formula, then replace the formula with a new formula
        /// </summary>
        [TestMethod]
        public void TestAddFormulThenReplaceWithNewFormula()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            List<String> expectedResults = new List<String>
            {
                "A1",
                "Z1"
            };

            sheet.SetContentsOfCell("A1", ("=C1 + B1 - 2"));
            List<String> actualResults = sheet.SetContentsOfCell("A1", ("=Z1 - 2")).ToList();

            for (int i = 0; i < actualResults.Count; i++)
                Assert.AreEqual(expectedResults.ElementAt(i), actualResults.ElementAt(i));
        }

        /// <summary>
        /// Tests try add a double cell
        /// </summary>
        [TestMethod]
        public void TestAddDoubleCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            List<String> actualResults = sheet.SetContentsOfCell("A1", "5.2").ToList();

            foreach (String st in actualResults)
                Assert.AreEqual("A1", st);
        }

        /// <summary>
        /// Tests try add a formula cell then replace with double cell
        /// </summary>
        [TestMethod]
        public void TestAddFormulaCellThenReplaceWithDoubleCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            List<String> expectedFirstResults = new List<string>
            {
                "A1",
                "D1",
                "Z1",
                "B1"
            };

            List<String> actualFirstResults = sheet.SetContentsOfCell("A1", ("=B1 + Z1 + D1")).ToList();

            for (int i = 0; i < actualFirstResults.Count; i++)
                Assert.AreEqual(expectedFirstResults.ElementAt(i), actualFirstResults.ElementAt(i));

            List<String> actualSecondResults = sheet.SetContentsOfCell("A1", "5.2").ToList();

            foreach (String st in actualSecondResults)
                Assert.AreEqual("A1", st);
        }

        /// <summary>
        /// Tests empty cell
        /// </summary>
        [TestMethod]
        public void TestEmptyCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            Assert.AreEqual("", sheet.GetCellContents("A1"));
        }

        /// <summary>
        /// Tests GetAllNonEmptyCells
        /// </summary>
        [TestMethod]
        public void TestGetAllNonEmptyCells()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            List<String> expectedResults = new List<string>
            {
                "A1",
                "B1",
                "C1"
            };

            sheet.SetContentsOfCell("A1", ("=B1 + C1"));
            sheet.SetContentsOfCell("B1", "5.2");
            sheet.SetContentsOfCell("C1", "6.2");

            List<String> returnedResutls = sheet.GetNamesOfAllNonemptyCells().ToList();

            for (int i = 0; i < returnedResutls.Count; i++)
                Assert.AreEqual(expectedResults.ElementAt(i), returnedResutls.ElementAt(i));
        }

        /// <summary>
        /// Tests GetAllNonEmptyCells with strings
        /// </summary>
        [TestMethod]
        public void TestGetAllNonEmptyCellsWithStrings()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            List<String> expectedResults = new List<string>
            {
                "A1",
                "B1",
                "C1"
            };

            sheet.SetContentsOfCell("A1", ("=B1 + C1"));
            sheet.SetContentsOfCell("B1", "String");
            sheet.SetContentsOfCell("C1", "String2");

            List<String> returnedResutls = sheet.GetNamesOfAllNonemptyCells().ToList();

            for (int i = 0; i < returnedResutls.Count; i++)
                Assert.AreEqual(expectedResults.ElementAt(i), returnedResutls.ElementAt(i));
        }

        /// <summary>
        /// Tests to see if formula tests for circular dep, should fail
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(CircularException))]
        public void TestForCircularDepCreatTextThenConvertToFormulaCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();

            sheet.SetContentsOfCell("B1", ("=A1 + C1"));
            sheet.SetContentsOfCell("C1", ("=A1"));
            sheet.SetContentsOfCell("A1", ("=B1"));
        }

        /// <summary>
        /// Tests to see if formula tests for circular dep, should fail
        /// creates the cell first as a double then trys to change it to
        /// a formula that should throw a circular exception
        /// 
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(CircularException))]
        public void TestForCircularDepCreatDoubleThenConvertToFormulaCell()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("A1", "5.10");
            Assert.IsTrue(sheet.GetCellContents("A1").GetType().Equals((typeof(Double))));

            sheet.SetContentsOfCell("B1", ("=A1 + C1"));
            sheet.SetContentsOfCell("C1", ("=A1"));
            sheet.SetContentsOfCell("A1", ("=B1"));
        }

        /// <summary>
        /// Tests creating multiple cells that are dependent on a text
        /// cell, then check the cells that depend on it to check the set
        /// </summary>
        [TestMethod]
        public void TestForDepOnTextCell()
        {
            List<String> expectedResults = new List<string>
            {
                "A1",
                "C1",
                "B1"
            };

            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("B1", ("=A1"));
            sheet.SetContentsOfCell("C1", ("=A1"));
            List<String> actualResults = sheet.SetContentsOfCell("A1", "String").ToList();

            for (int i = 0; i < actualResults.Count; i++)
                Assert.AreEqual(expectedResults.ElementAt(i), actualResults.ElementAt(i));

        }

        /// <summary>
        /// Tests for a valid cell name
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void TestForInvalidCellName()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("$A1$", ("=A1"));
        }

        /// <summary>
        /// Tests for a valid cell name with "2x"
        /// </summary>
        [TestMethod]
        [ExpectedException(typeof(InvalidNameException))]
        public void TestForInvalidCellName2x()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("2x", ("=A1"));
        }

        /// <summary>
        /// Tests for a valid cell name with "X0"
        /// </summary>
        [TestMethod]
        public void TestForInvalidCellNameX0()
        {
            AbstractSpreadsheet sheet = new Spreadsheet();
            sheet.SetContentsOfCell("X0", ("=A1"));
        }

        // EMPTY SPREADSHEETS
        [TestMethod()]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test1()
        {
            Spreadsheet s = new Spreadsheet();
            s.GetCellContents(null);
        }

        [TestMethod()]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test2()
        {
            Spreadsheet s = new Spreadsheet();
            s.GetCellContents("1AA");
        }

        [TestMethod()]
        public void Test3()
        {
            Spreadsheet s = new Spreadsheet();
            Assert.AreEqual("", s.GetCellContents("A2"));
        }

        // SETTING CELL TO A DOUBLE
        [TestMethod()]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test4()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell(null, "1.5");
        }

        [TestMethod()]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test5()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("1A1A", "1.5");
        }

        [TestMethod()]
        public void Test6()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("Z7", "1.5");
            Assert.AreEqual(1.5, (double)s.GetCellContents("Z7"), 1e-9);
        }

        // SETTING CELL TO A STRING
        [TestMethod()]
        [ExpectedException(typeof(ArgumentNullException))]
        public void Test7()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A8", (string)null);
        }

        [TestMethod()]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test8()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell(null, "hello");
        }

        [TestMethod()]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test9()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("1AZ", "hello");
        }

        [TestMethod()]
        public void Test10()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("Z7", "hello");
            Assert.AreEqual("hello", s.GetCellContents("Z7"));
        }

        // SETTING CELL TO A FORMULA
        [TestMethod()]
        [ExpectedException(typeof(ArgumentNullException))]
        public void Test11()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A8", null);
        }

        [TestMethod()]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test12()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell(null, ("=2"));
        }

        [TestMethod()]
        [ExpectedException(typeof(InvalidNameException))]
        public void Test13()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("1AZ", ("=2"));
        }

        // CIRCULAR FORMULA DETECTION
        [TestMethod()]
        [ExpectedException(typeof(CircularException))]
        public void Test15()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A1", ("=A2"));
            s.SetContentsOfCell("A2", ("=A1"));
        }

        [TestMethod()]
        [ExpectedException(typeof(CircularException))]
        public void Test16()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A1", ("=A2+A3"));
            s.SetContentsOfCell("A3", ("=A4+A5"));
            s.SetContentsOfCell("A5", ("=A6+A7"));
            s.SetContentsOfCell("A7", ("=A1+A1"));
        }

        [TestMethod()]
        [ExpectedException(typeof(CircularException))]
        public void Test17()
        {
            Spreadsheet s = new Spreadsheet();
            try
            {
                s.SetContentsOfCell("A1", ("=A2+A3"));
                s.SetContentsOfCell("A2", "15");
                s.SetContentsOfCell("A3", "30");
                s.SetContentsOfCell("A2", ("=A3*A1"));
            }
            catch (CircularException e)
            {
                Assert.AreEqual(15, (double)s.GetCellContents("A2"), 1e-9);
                throw e;
            }
        }

        // NONEMPTY CELLS
        [TestMethod()]
        public void Test18()
        {
            Spreadsheet s = new Spreadsheet();
            Assert.IsFalse(s.GetNamesOfAllNonemptyCells().GetEnumerator().MoveNext());
        }

        [TestMethod()]
        public void Test19()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("B1", "");
            Assert.IsFalse(s.GetNamesOfAllNonemptyCells().GetEnumerator().MoveNext());
        }

        [TestMethod()]
        public void Test20()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("B1", "hello");
            Assert.IsTrue(new HashSet<string>(s.GetNamesOfAllNonemptyCells()).SetEquals(new HashSet<string>() { "B1" }));
        }

        [TestMethod()]
        public void Test21()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("B1", "52.25");
            Assert.IsTrue(new HashSet<string>(s.GetNamesOfAllNonemptyCells()).SetEquals(new HashSet<string>() { "B1" }));
        }

        [TestMethod()]
        public void Test22()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("B1", ("=3.5"));
            Assert.IsTrue(new HashSet<string>(s.GetNamesOfAllNonemptyCells()).SetEquals(new HashSet<string>() { "B1" }));
        }

        [TestMethod()]
        public void Test23()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A1", "17.2");
            s.SetContentsOfCell("C1", "hello");
            s.SetContentsOfCell("B1", ("=3.5"));
            Assert.IsTrue(new HashSet<string>(s.GetNamesOfAllNonemptyCells()).SetEquals(new HashSet<string>() { "A1", "B1", "C1" }));
        }

        // RETURN VALUE OF SET CELL CONTENTS
        [TestMethod()]
        public void Test24()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("B1", "hello");
            s.SetContentsOfCell("C1", ("=5"));
            Assert.IsTrue(s.SetContentsOfCell("A1", "17.2").SetEquals(new HashSet<string>() { "A1" }));
        }

        [TestMethod()]
        public void Test25()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A1", "17.2");
            s.SetContentsOfCell("C1", ("=5"));
            Assert.IsTrue(s.SetContentsOfCell("B1", "hello").SetEquals(new HashSet<string>() { "B1" }));
        }

        [TestMethod()]
        public void Test26()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A1", "17.2");
            s.SetContentsOfCell("B1", "hello");
            Assert.IsTrue(s.SetContentsOfCell("C1", ("=5")).SetEquals(new HashSet<string>() { "C1" }));
        }

        [TestMethod()]
        public void Test27()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A1", ("=A2+A3"));
            s.SetContentsOfCell("A2", "6");
            s.SetContentsOfCell("A3", ("=A2+A4"));
            s.SetContentsOfCell("A4", ("=A2+A5"));
            Assert.IsTrue(s.SetContentsOfCell("A5", "82.5").SetEquals(new HashSet<string>() { "A5", "A4", "A3", "A1" }));
        }

        // CHANGING CELLS
        [TestMethod()]
        public void Test28()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A1", ("=A2+A3"));
            s.SetContentsOfCell("A1", "2.5");
            Assert.AreEqual(2.5, (double)s.GetCellContents("A1"), 1e-9);
        }

        [TestMethod()]
        public void Test29()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A1", ("=A2+A3"));
            s.SetContentsOfCell("A1", "Hello");
            Assert.AreEqual("Hello", (string)s.GetCellContents("A1"));
        }



        // STRESS TESTS
        [TestMethod()]
        public void Test31()
        {
            Spreadsheet s = new Spreadsheet();
            s.SetContentsOfCell("A1", ("=B1+B2"));
            s.SetContentsOfCell("B1", ("=C1-C2"));
            s.SetContentsOfCell("B2", ("=C3*C4"));
            s.SetContentsOfCell("C1", ("=D1*D2"));
            s.SetContentsOfCell("C2", ("=D3*D4"));
            s.SetContentsOfCell("C3", ("=D5*D6"));
            s.SetContentsOfCell("C4", ("=D7*D8"));
            s.SetContentsOfCell("D1", ("=E1"));
            s.SetContentsOfCell("D2", ("=E1"));
            s.SetContentsOfCell("D3", ("=E1"));
            s.SetContentsOfCell("D4", ("=E1"));
            s.SetContentsOfCell("D5", ("=E1"));
            s.SetContentsOfCell("D6", ("=E1"));
            s.SetContentsOfCell("D7", ("=E1"));
            s.SetContentsOfCell("D8", ("=E1"));
            ISet<String> cells = s.SetContentsOfCell("E1", "0");
            Assert.IsTrue(new HashSet<string>() { "A1", "B1", "B2", "C1", "C2", "C3", "C4", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "D8", "E1" }.SetEquals(cells));
        }
        [TestMethod()]
        public void Test32()
        {
            Test31();
        }
        [TestMethod()]
        public void Test33()
        {
            Test31();
        }
        [TestMethod()]
        public void Test34()
        {
            Test31();
        }

        [TestMethod()]
        public void Test35()
        {
            Spreadsheet s = new Spreadsheet();
            ISet<String> cells = new HashSet<string>();
            for (int i = 1; i < 200; i++)
            {
                cells.Add("A" + i);
                Assert.IsTrue(cells.SetEquals(s.SetContentsOfCell("A" + i, ("=A" + (i + 1)))));
            }
        }
        [TestMethod()]
        public void Test36()
        {
            Test35();
        }
        [TestMethod()]
        public void Test37()
        {
            Test35();
        }
        [TestMethod()]
        public void Test38()
        {
            Test35();
        }
        [TestMethod()]
        public void Test39()
        {
            Spreadsheet s = new Spreadsheet();
            for (int i = 1; i < 200; i++)
            {
                s.SetContentsOfCell("A" + i, ("=A" + (i + 1)));
            }
            try
            {
                s.SetContentsOfCell("A150", ("=A50"));
                Assert.Fail();
            }
            catch (CircularException)
            {
            }
        }
        [TestMethod()]
        public void Test40()
        {
            Test39();
        }
        [TestMethod()]
        public void Test41()
        {
            Test39();
        }
        [TestMethod()]
        public void Test42()
        {
            Test39();
        }

        /*
        [TestMethod()]
        public void Test44()
        {
            Test43();
        }
        [TestMethod()]
        public void Test45()
        {
            Test43();
        }
        [TestMethod()]
        public void Test46()
        {
            Test43();
        }
        */

        [TestMethod()]
        public void Test47()
        {
            RunRandomizedTest(47, 2519);
        }
        [TestMethod()]
        public void Test48()
        {
            RunRandomizedTest(48, 2521);
        }
        [TestMethod()]
        public void Test49()
        {
            RunRandomizedTest(49, 2526);
        }
        [TestMethod()]
        public void Test50()
        {
            RunRandomizedTest(50, 2521);
        }

        public void RunRandomizedTest(int seed, int size)
        {
            Spreadsheet s = new Spreadsheet();
            Random rand = new Random(seed);
            for (int i = 0; i < 10000; i++)
            {
                try
                {
                    switch (rand.Next(3))
                    {
                        case 0:
                            s.SetContentsOfCell(randomName(rand), "3.14");
                            break;
                        case 1:
                            s.SetContentsOfCell(randomName(rand), "hello");
                            break;
                        case 2:
                            s.SetContentsOfCell(randomName(rand), randomFormula(rand));
                            break;
                    }
                }
                catch (CircularException)
                {
                }
            }
            ISet<string> set = new HashSet<string>(s.GetNamesOfAllNonemptyCells());
            Assert.AreEqual(size, set.Count);
        }

        private String randomName(Random rand)
        {
            return "ABCDEFGHIJKLMNOPQRSTUVWXYZ".Substring(rand.Next(26), 1) + (rand.Next(99) + 1);
        }

        private String randomFormula(Random rand)
        {
            String f = randomName(rand);
            for (int i = 0; i < 10; i++)
            {
                switch (rand.Next(4))
                {
                    case 0:
                        f += "+";
                        break;
                    case 1:
                        f += "-";
                        break;
                    case 2:
                        f += "*";
                        break;
                    case 3:
                        f += "/";
                        break;
                }
                switch (rand.Next(2))
                {
                    case 0:
                        f += 7.2;
                        break;
                    case 1:
                        f += randomName(rand);
                        break;
                }
            }
            return f;
        }

    }
}

